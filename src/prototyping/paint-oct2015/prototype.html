<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CinsImp Paint Tool Prototype</title>
<script src="Drag.js"></script>
<style>

.PaintCanvas
{
	display: block;
	position: relative;
	margin: 20px;
	border: 1px solid black;
	background-color: white;
	width: 600px;
	height: 400px;
	float: left;
	overflow: hidden;
}

.Swatch
{
	display: inline-block;
	width: 20px;
	height: 20px;
	margin: 0;
	margin-right: 1px;
	margin-bottom: 1px;
}

.SelectedGfx
{
	display: block;
	position: absolute;
	visibility: hidden;
	border: 1px dashed gray;
	/*z-index: 1;*/
	cursor: move;
}

</style>
<script>

/*
Aside from paste from clipboard, can potentially do an Import Paint command,
which would upload the picture or provide it via a file select dialog,
and then provide the usual rectangular selection mechanism to allow positioning.
*/


function _PaintSelection(in_element)
{
	this._element = in_element;
}


_PaintSelection.prototype.getLoc = function()
{
	return [this._element.offsetLeft, this._element.offsetTop];
}


_PaintSelection.prototype.setLoc = function(in_loc)
{
	this._element.style.left = in_loc[0] + 'px';
	this._element.style.top = in_loc[1] + 'px';
}



function Paint(in_container)
{
	this._container = in_container;
	this._in_paint = false;
	
	this.ontoolchange = null;
	
	this._init();
}


Paint.TOOL_BROWSE = 1;
Paint.TOOL_SELECT = 4;
Paint.TOOL_LASSO = 5;
Paint.TOOL_PENCIL = 6;
Paint.TOOL_BRUSH = 7;
Paint.TOOL_ERASER = 8;
Paint.TOOL_LINE = 9;
Paint.TOOL_SPRAY = 10;
Paint.TOOL_RECTANGLE = 11;
Paint.TOOL_ROUND_RECT = 12;
Paint.TOOL_BUCKET = 13;
Paint.TOOL_OVAL = 14;
Paint.TOOL_FREE_SHAPE = 15;
Paint.TOOL_TEXT = 16;
Paint.TOOL_REG_POLY = 17;
Paint.TOOL_FREE_POLY = 18;
Paint.TOOL_EYEDROPPER = 19;


Paint.prototype._init = function()
{
	var me = this;
	
	this._main = document.createElement('canvas');
	this._main.style.position = 'absolute';
	this._main.style.left = '0px';
	this._main.style.top = '0px';
	this._main.style.width = this._container.clientWidth + 'px';
	this._main.style.height = this._container.clientHeight + 'px';
	
	this._main.addEventListener('mousedown', function(in_event) { 
		me._handle_touch_begin([in_event.pageX, in_event.pageY]); 
		in_event.preventDefault(); in_event.stopPropagation(); });
	
	this._ctx = this._main.getContext('2d');
	
	this._pastecatcher = document.createElement('div');
	this._pastecatcher.style.cssText = 'opacity: 0; position: fixed; top: 0px; left: 0px; width: 0px; height: 0px; overflow: hidden;';
	this._pastecatcher.contentEditable = true;
	this._pastecatcher.addEventListener('DOMSubtreeModified', this._handle_dom_paste.bind(this));
	document.body.appendChild(this._pastecatcher);
	
	this._selected = document.createElement('div');
	this._selected.className = 'SelectedGfx';
	
	
	this._selected.addEventListener('mousedown', this._selection_grab.bind(this));
	this._selected.addEventListener('touchstart', this._selection_grab.bind(this));
	
	this._selection = new _PaintSelection(this._selected);
	
	this._container.appendChild(this._main);
	this._container.appendChild(this._selected);
}


Paint.prototype._handle_touch_begin = function(in_loc)
{
	this._drop_selection();
	
}


Paint.prototype._drop_selection = function()
{
	if (this._selected.style.visibility == 'hidden') return;
	
	
	
	this._selected.style.visibility = 'hidden';
}


Paint.prototype._selection_grab = function(in_event)
{
	//alert('Grab selection');
	Drag.beginObjectMove(in_event, this._selection);
	in_event.preventDefault();
	in_event.stopPropagation();
}


Paint.prototype._enter_paint = function()
{
	this._in_paint = true;
	
	this._listeners = [
		this._handle_keydown.bind(this),
		this._handle_keydown.bind(this),
		this._handle_event_paste.bind(this)
		];
	document.addEventListener('keydown', this._listeners[0]);
	document.addEventListener('keyup', this._listeners[1]);
	document.addEventListener('paste', this._listeners[2]);
}


Paint.prototype._exit_paint = function()
{
	this._in_paint = false;
	
	document.removeEventListener('keydown', this._listeners[0]);
	document.removeEventListener('keyup', this._listeners[1]);
	document.removeEventListener('paste', this._listeners[2]);
}


Paint.prototype._handle_keydown = function(in_event)
{
	if (in_event.ctrlKey || in_event.metaKey)
		this._pastecatcher.focus();
}


Paint.prototype._handle_keyup = function(in_event)
{
	
}


/*
	This receives an image source as the result of a paste or import paint operation.
*/
Paint.prototype._paste_create_image = function(in_source)
{
	if (!in_source) return;
	
	var me = this;
	var img = document.createElement('img');
	img.onload = function()
	{
		me.choose_tool(Paint.TOOL_SELECT);
		
		me._selected.innerHTML = '';
		me._selected.appendChild(img);
	
		me._selected.style.left = (me._container.clientWidth - this.clientWidth) / 2 + 'px';
		me._selected.style.top = (me._container.clientHeight - this.clientHeight) / 2 + 'px';
		me._selected.style.visibility = 'visible';
	}
	img.src = in_source;

	//document.getElementById('PasteCheck').src = in_source;
}


/*
	Allows a direct import by file selection.
*/
Paint.prototype.import_paint = function(in_input_element)
{
	this._paste_create_image(URL.createObjectURL(in_input_element.files[0]));
}


/*
	For browsers such as Firefox, where a pasted image must go into an editable
	content element, we retrieve the pasted image from this element.
*/
Paint.prototype._handle_dom_paste = function()
{
	if (this._pastecatcher.children.length == 1)
	{
		try 
		{
			var source = this._pastecatcher.firstElementChild.src;
			this._paste_create_image(source);
		}
		catch (err) {}
	}
    
    this._pastecatcher.innerHTML = '';
}


/*
	For browsers such as Chrome, which support the HTML5 Clipboard functionality,
	we retrieve the pasted image directly.
*/
Paint.prototype._handle_event_paste = function(in_event)
{
	if (!in_event.clipboardData) 
	{
		window.setTimeout(this._handle_dom_paste.bind(this), 1);
		return;
	}
	
	var items = in_event.clipboardData.items;
	if (!items) return;
	
	for (var i = 0; i < items.length; i++)
	{
		if (items[i].type.indexOf('image') == -1) continue;
		var blob = items[i].getAsFile();
		var url = window.URL || window.webkitURL;
		var source = url.createObjectURL(blob);
		
		this._paste_create_image(source);
		break;
	}
}


Paint.prototype.choose_tool = function(in_tool)
{
	if (this._tool == in_tool) return;
	
	this._tool = in_tool;
	if (in_tool == Paint.TOOL_BROWSE && this._in_paint)
		this._exit_paint();
	else if (in_tool != Paint.TOOL_BROWSE && (!this._in_paint))
		this._enter_paint();
		
	if (in_tool == Paint.TOOL_BROWSE)
		this._drop_selection();
	
	if (this.ontoolchange)
		this.ontoolchange(this._tool);
}


Paint.prototype.choose_color = function(in_color)
{
	this._color = in_color;
	
}




</script>
<script language="javascript" type="text/javascript" src="colours.js"></script>
</head>
<body>

<div id="Container" class="PaintCanvas">



</div>

<div id="ToolPalette" style="width: 120px; float: left;margin-top: 30px;">
<img src="gfx/browse-normal.png" width="32" onclick="choose_tool(Paint.TOOL_BROWSE);" style="margin-right: 64px;">
<img src="gfx/select-normal.png" width="32" onclick="choose_tool(Paint.TOOL_SELECT);">
<img src="gfx/lasso-normal.png" width="32" onclick="choose_tool(Paint.TOOL_LASSO);">
<img src="gfx/pencil-normal.png" width="32" onclick="choose_tool(Paint.TOOL_PENCIL);">
<img src="gfx/brush-normal.png" width="32" onclick="choose_tool(Paint.TOOL_BRUSH);">
<img src="gfx/eraser-normal.png" width="32" onclick="choose_tool(Paint.TOOL_ERASER);">
<img src="gfx/line-normal.png" width="32" onclick="choose_tool(Paint.TOOL_LINE);">
<img src="gfx/spray-normal.png" width="32" onclick="choose_tool(Paint.TOOL_SPRAY);">
<img src="gfx/rectangle-normal.png" width="32" onclick="choose_tool(Paint.TOOL_RECTANGLE);">
<img src="gfx/roundrect-normal.png" width="32" onclick="choose_tool(Paint.TOOL_ROUND_RECT);">
<img src="gfx/bucket-normal.png" width="32" onclick="choose_tool(Paint.TOOL_BUCKET);">
<img src="gfx/oval-normal.png" width="32" onclick="choose_tool(Paint.TOOL_OVAL);">
<img src="gfx/freeshape-normal.png" width="32" onclick="choose_tool(Paint.TOOL_FREE_SHAPE);">
<img src="gfx/text-normal.png" width="32" onclick="choose_tool(Paint.TOOL_TEXT);">
<img src="gfx/regpoly-normal.png" width="32" onclick="choose_tool(Paint.TOOL_REG_POLY);">
<img src="gfx/freepoly-normal.png" width="32" onclick="choose_tool(Paint.TOOL_FREE_POLY);">
<img src="gfx/eyedrop-normal.png" width="32" onclick="choose_tool(Paint.TOOL_EYEDROPPER);">
</div>


<div id="ColorSwatchTable" style="width: 650px; clear: left; font-size: 0;">
</div>


<script>


var gPaint = new Paint(document.getElementById('Container'));


function choose_tool(in_tool)
{
	var img_list = document.getElementById('ToolPalette').children;
	for (var t = 0; t < img_list.length; t++)
	{
		var palette_img = img_list[t];
		palette_img.src = palette_img.src.replace('hilite', 'normal');
	}
	
	/* set the new tool indication */
	var tool_idx = in_tool - 1;
	if (tool_idx > 1) tool_idx -= 2;
	var palette_img = document.getElementById('ToolPalette').children[tool_idx];
	palette_img.src = palette_img.src.replace('normal', 'hilite');
	
	gPaint.choose_tool(in_tool);
}
gPaint.ontoolchange = choose_tool;


function chooseColour(in_event)
{
	var e = in_event || window.event;
	var dom_swatch = e.target;
	var color = dom_swatch.style.backgroundColor.replace('rgb(','').replace(')','').split(',');
	color[0] = color[0] * 1;
	color[1] = color[1] * 1;
	color[2] = color[2] * 1;
	gPaint.choose_color(color);
}


function setupColours()
{
	var dom_table = document.getElementById('ColorSwatchTable');
	
	for (var c = 0; c < Colours.DEFAULT_SET.length; c++)
	{
		var colour = Colours.DEFAULT_SET[c];
		
		var dom_swatch = document.createElement('div');
		dom_swatch.className = 'Swatch';
		dom_swatch.style.backgroundColor = 'rgba('+colour[0]+','+colour[1]+','+colour[2]+',1)';
		dom_table.appendChild(dom_swatch);
		
		dom_swatch.addEventListener('mousedown', chooseColour);
	}
	
	/*var cell_size = dom_table.children[0].clientWidth;
	var per_row = Math.floor(dom_table.clientWidth / dom_table.children[0].clientWidth);
	var rows = Math.ceil(Colours.DEFAULT_SET.length / per_row);
	
	dom_ele.style.width = per_row * cell_size + 'px';
	dom_ele.style.height = rows * cell_size + 'px';*/
	
	
}

setupColours();
choose_tool(Paint.TOOL_BROWSE);
gPaint.choose_color([0,0,0]);

</script>



<h2>Import Paint</h2>
<div><input type="file" id="ImportPaintFile" onchange="gPaint.import_paint(this);"></div>


<h2>Preview</h2>

<div><img src="" id="PasteCheck"></div>

</body>
</html>
