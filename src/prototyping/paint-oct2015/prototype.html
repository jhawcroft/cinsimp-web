<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CinsImp Paint Tool Prototype</title>
<script language="javascript" type="text/javascript" src="drag.js"></script>
<style>

.PaintCanvas
{
	display: block;
	position: relative;
	margin: 20px;
	border: 1px solid black;
	background-color: white;
	width: 600px;
	height: 400px;
	float: left;
	overflow: hidden;
}

.Swatch
{
	display: inline-block;
	width: 20px;
	height: 20px;
	margin: 0;
	margin-right: 1px;
	margin-bottom: 1px;
}

.SelectedGfx
{
	display: block;
	position: absolute;
	visibility: hidden;
	border: 1px dashed gray;
	/*z-index: 1;*/
	cursor: move;
	margin: 0;
	padding: 0;
	overflow: hidden;
	font-size: 0;
}

.SelectedGfx img
{
	display: block;
	position: absolute;
	left: 0;
	top: 0;
	margin: 0;
}

.CursCrosshair
{
	cursor: url('gfx/CursorCrosshair.png'), crosshair;
}

.CursEraser
{
	cursor: url('gfx/CursorEraser.png'), crosshair;
}

</style>
<script>

/*
Aside from paste from clipboard, can potentially do an Import Paint command,
which would upload the picture or provide it via a file select dialog,
and then provide the usual rectangular selection mechanism to allow positioning.
*/


function _PaintSelection(in_element)
{
	this._element = in_element;
}


_PaintSelection.prototype.get_loc = function()
{
	return [this._element.offsetLeft, this._element.offsetTop];
}


_PaintSelection.prototype.set_loc = function(in_loc)
{
	this._element.style.left = in_loc[0] + 'px';
	this._element.style.top = in_loc[1] + 'px';
}


_PaintSelection.prototype.get_size = function()
{
	return [this._element.clientWidth, this._element.clientHeight];
}


_PaintSelection.prototype.set_size = function(in_size)
{
	this._element.style.width = in_size[0] + 'px';
	this._element.style.height = in_size[1] + 'px';
}


_PaintSelection.prototype.is_zero = function()
{
	return (this._element.clientWidth == 0 && this._element.clientHeight == 0);
}


_PaintSelection.prototype.hide = function()
{
	this._element.style.visibility = 'hidden';
}


_PaintSelection.prototype.show = function()
{
	this._element.style.visibility = 'visible';
}


_PaintSelection.prototype.is_active = function()
{
	return (this._element.style.visibility == 'visible');
}




function Paint(in_container, in_size)
{
	this._container = in_container;
	this._in_paint = false;
	this._size = in_size;
	this._touching = false;
	
	this.ontoolchange = null;
	
	this._init();
}


Paint.TOOL_BROWSE = 1;
Paint.TOOL_SELECT = 4;
Paint.TOOL_LASSO = 5;
Paint.TOOL_PENCIL = 6;
Paint.TOOL_BRUSH = 7;
Paint.TOOL_ERASER = 8;
Paint.TOOL_LINE = 9;
Paint.TOOL_SPRAY = 10;
Paint.TOOL_RECTANGLE = 11;
Paint.TOOL_ROUND_RECT = 12;
Paint.TOOL_BUCKET = 13;
Paint.TOOL_OVAL = 14;
Paint.TOOL_FREE_SHAPE = 15;
Paint.TOOL_TEXT = 16;
Paint.TOOL_REG_POLY = 17;
Paint.TOOL_FREE_POLY = 18;
Paint.TOOL_EYEDROPPER = 19;


Paint.prototype._rel_loc = function(in_event)
{
	var loc = [0,0];
	
	if (in_event.pageX)
	{
		loc[0] = in_event.pageX;
		loc[1] = in_event.pageY;
	}
	else
	{
		loc[0] = in_event.touches[0].pageX;
		loc[1] = in_event.touches[0].pageY;
	}
	
	var cr = this._container.getBoundingClientRect();
	loc[0] -= cr.left;
	loc[1] -= cr.top;
	
	return loc;
}


Paint.prototype._page_loc = function(in_event)
{
	if (in_event.pageX)
		return [in_event.pageX, in_event.pageY];
	else
		return [in_event.touches[0].pageX, in_event.touches[0].pageY];
}


Paint.prototype._init = function()
{
	var me = this;
	
	this._main = document.createElement('canvas');
	this._main.style.position = 'absolute';
	this._main.style.left = '0px';
	this._main.style.top = '0px';
	this._main.width = this._size[0];
	this._main.height = this._size[1];
	
	this._main.addEventListener('mousedown', function(in_event) { 
		me._touching = true; me._handle_touch_begin(me._page_loc(in_event), me._rel_loc(in_event)); 
		in_event.preventDefault(); in_event.stopPropagation(); });
	this._main.addEventListener('mousemove', function(in_event) { 
		if (!me._touching) return; me._handle_touch_continue(me._page_loc(in_event), me._rel_loc(in_event)); 
		//in_event.preventDefault(); in_event.stopPropagation(); 
		});
	this._main.addEventListener('mouseup', function(in_event) { 
		me._touching = false;  
		//in_event.preventDefault(); in_event.stopPropagation();
		 });
		 
	this._main.addEventListener('touchstart', function(in_event) {
		me._touching = true; me._handle_touch_begin(me._page_loc(in_event), me._rel_loc(in_event)); 
		in_event.preventDefault(); in_event.stopPropagation();
	});
	this._main.addEventListener('touchmove', function(in_event) {
		if (!me._touching) return; me._handle_touch_continue(me._page_loc(in_event), me._rel_loc(in_event)); 
	});
	this._main.addEventListener('touchend', function(in_event) {
		me._touching = false; 
	});
	
	this._ctx = this._main.getContext('2d');
	
	this._pastecatcher = document.createElement('div');
	this._pastecatcher.style.cssText = 'opacity: 0; position: fixed; top: 0px; left: 0px; width: 0px; height: 0px; overflow: hidden;';
	this._pastecatcher.contentEditable = true;
	this._pastecatcher.addEventListener('DOMSubtreeModified', this._handle_dom_paste.bind(this));
	document.body.appendChild(this._pastecatcher);
	
	this._selected = document.createElement('div');
	this._selected.className = 'SelectedGfx';
	this._selected.style.visibility = 'hidden';
	
	this._selected.addEventListener('mousedown', this._selection_grab.bind(this));
	this._selected.addEventListener('touchstart', this._selection_grab.bind(this));
	
	this._selection = new _PaintSelection(this._selected);
	
	this._container.appendChild(this._main);
	this._container.appendChild(this._selected);
}


Paint.prototype._selection_finish = function()
{
	if (this._selection.is_zero())
		this._selection.hide();
	else
		this.pickup_selection();
}


Paint.prototype.pickup_selection = function()
{
	var loc = this._selection.get_loc();
	var size = this._selection.get_size();
	
	var temp = document.createElement('canvas');
	temp.width = size[0];
	temp.height = size[1];
	var ctx2 = temp.getContext('2d');
	
	ctx2.drawImage(this._main, loc[0]+2, loc[1]+2, size[0], size[1], 0, 0, size[0], size[1]);
	
	var source = temp.toDataURL("image/png");
	var img = document.createElement('img');
	img.src = source;
	
	this._selected.innerHTML = '';
	this._selected.appendChild(img);
	this._selected.style.width = size[0] + 'px';
	this._selected.style.height = size[1] + 'px';
	this._selection.show();
}


Paint.prototype._apply_eraser = function(in_rel_loc)
{
	this._ctx.clearRect(in_rel_loc[0], in_rel_loc[1], 16, 16);
}


Paint.prototype._handle_touch_continue = function(in_page_loc, in_rel_loc)
{
	switch (this._tool)
	{
	case Paint.TOOL_ERASER:
		this._apply_eraser(in_rel_loc);
		break;
	}
}


Paint.prototype._handle_touch_begin = function(in_page_loc, in_rel_loc)
{
	this._drop_selection();
	
	switch (this._tool)
	{
	case Paint.TOOL_SELECT:
		this._selected.innerHTML = '';
		this._selection.set_loc(in_rel_loc);
		this._selection.set_size([0,0]);
		this._selected.style.visibility = 'visible';
		Drag.begin_resize(in_page_loc, [this._selection], null, this._selection_finish.bind(this));
		break;
	
	case Paint.TOOL_LASSO:
		/* can handle this by: a) allowing the construction of a path,
		b) filling the shape formed by the path, within an offscreen context,
		c) copying the pixels 1-by-1 from the main canvas to the selection canvas
			based on the presence of a non-white pixel in the offscreen context,
			or contained within the lasso path;
		Then selection operates as virtually as normal, even potentially with
		a rectangular outline. */
		break;
	
	case Paint.TOOL_ERASER:
		this._apply_eraser(in_rel_loc);
		break;
	}
}


Paint.prototype._drop_selection = function()
{
	if (!this._selection.is_active()) return;
	
	if (this._selected.children.length == 1)
		this._ctx.drawImage(this._selected.children[0], this._selected.offsetLeft + 2, this._selected.offsetTop + 2);
	
	this._selection.hide();
}


Paint.prototype._selection_grab = function(in_event)
{
	var loc = this._page_loc(in_event);

	/* really should be doing pickup here if the thing isn't picked up - ie. is not having an image... */
	Drag.begin_move(loc, [this._selection], null, null);
	
	in_event.preventDefault();
	in_event.stopPropagation();
}


Paint.prototype._enter_paint = function()
{
	this._in_paint = true;
	
	this._listeners = [
		this._handle_keydown.bind(this),
		this._handle_keydown.bind(this),
		this._handle_event_paste.bind(this)
		];
	document.addEventListener('keydown', this._listeners[0]);
	document.addEventListener('keyup', this._listeners[1]);
	document.addEventListener('paste', this._listeners[2]);
}


Paint.prototype._exit_paint = function()
{
	this._in_paint = false;
	
	document.removeEventListener('keydown', this._listeners[0]);
	document.removeEventListener('keyup', this._listeners[1]);
	document.removeEventListener('paste', this._listeners[2]);
}


Paint.prototype._handle_keydown = function(in_event)
{
	if (in_event.ctrlKey || in_event.metaKey)
		this._pastecatcher.focus();
}


Paint.prototype._handle_keyup = function(in_event)
{
	
}


Paint.prototype._centre_selection = function()
{
	this._selected.style.left = (this._container.clientWidth - this._selected.clientWidth) / 2 + 'px';
	this._selected.style.top = (this._container.clientHeight - this._selected.clientHeight) / 2 + 'px';
	this._selected.style.width = this._selected.clientWidth + 'px';
	this._selected.style.height = this._selected.clientHeight + 'px';
}


/*
	This receives an image source as the result of a paste or import paint operation.
*/
Paint.prototype._paste_create_image = function(in_source)
{
	if (!in_source) return;
	
	var me = this;
	var img = document.createElement('img');
	img.onload = function()
	{
		me.choose_tool(Paint.TOOL_SELECT);
		
		me._selected.innerHTML = '';
		me._selected.appendChild(img);
	
		me._selected.style.width = img.clientWidth + 'px';
		me._selected.style.height = img.clientHeight + 'px';
		me._centre_selection();
		me._selected.style.visibility = 'visible';
	}
	img.src = in_source;

	//document.getElementById('PasteCheck').src = in_source;
}


/*
	Allows a direct import by file selection.
*/
Paint.prototype.import_paint = function(in_input_element)
{
	this._paste_create_image(URL.createObjectURL(in_input_element.files[0]));
}


/*
	For browsers such as Firefox, where a pasted image must go into an editable
	content element, we retrieve the pasted image from this element.
*/
Paint.prototype._handle_dom_paste = function()
{
	if (this._pastecatcher.children.length == 1)
	{
		try 
		{
			var source = this._pastecatcher.firstElementChild.src;
			this._paste_create_image(source);
		}
		catch (err) {}
	}
    
    this._pastecatcher.innerHTML = '';
}


/*
	For browsers such as Chrome, which support the HTML5 Clipboard functionality,
	we retrieve the pasted image directly.
*/
Paint.prototype._handle_event_paste = function(in_event)
{
	if (!in_event.clipboardData) 
	{
		window.setTimeout(this._handle_dom_paste.bind(this), 1);
		return;
	}
	
	var items = in_event.clipboardData.items;
	if (!items) return;
	
	for (var i = 0; i < items.length; i++)
	{
		if (items[i].type.indexOf('image') == -1) continue;
		var blob = items[i].getAsFile();
		var url = window.URL || window.webkitURL;
		var source = url.createObjectURL(blob);
		
		this._paste_create_image(source);
		break;
	}
}


Paint.prototype.choose_tool = function(in_tool)
{
	if (this._tool == in_tool) return;
	
	this._tool = in_tool;
	if (in_tool == Paint.TOOL_BROWSE && this._in_paint)
		this._exit_paint();
	else if (in_tool != Paint.TOOL_BROWSE && (!this._in_paint))
		this._enter_paint();
		
	//if (in_tool == Paint.TOOL_BROWSE) /* eventually may be able to use other tools within the selection - if it's canvas based */
		this._drop_selection();
		
	this._main.classList.remove('CursCrosshair');
	this._main.classList.remove('CursEraser');
	switch (in_tool)
	{
	case Paint.TOOL_SELECT:
		this._main.classList.add('CursCrosshair');
		break;
	case Paint.TOOL_ERASER:
		this._main.classList.add('CursEraser');
		break;
	}
	
	if (this.ontoolchange)
		this.ontoolchange(this._tool);
}


Paint.prototype.choose_color = function(in_color)
{
	this._color = in_color;
	
}




</script>
<script language="javascript" type="text/javascript" src="colours.js"></script>
</head>
<body>

<div id="Container" class="PaintCanvas">



</div>

<div id="ToolPalette" style="width: 120px; float: left;margin-top: 30px;">
<img src="gfx/browse-normal.png" width="32" onclick="choose_tool(Paint.TOOL_BROWSE);" style="margin-right: 64px;">
<img src="gfx/select-normal.png" width="32" onclick="choose_tool(Paint.TOOL_SELECT);">
<img src="gfx/lasso-normal.png" width="32" onclick="choose_tool(Paint.TOOL_LASSO);">
<img src="gfx/pencil-normal.png" width="32" onclick="choose_tool(Paint.TOOL_PENCIL);">
<img src="gfx/brush-normal.png" width="32" onclick="choose_tool(Paint.TOOL_BRUSH);">
<img src="gfx/eraser-normal.png" width="32" onclick="choose_tool(Paint.TOOL_ERASER);">
<img src="gfx/line-normal.png" width="32" onclick="choose_tool(Paint.TOOL_LINE);">
<img src="gfx/spray-normal.png" width="32" onclick="choose_tool(Paint.TOOL_SPRAY);">
<img src="gfx/rectangle-normal.png" width="32" onclick="choose_tool(Paint.TOOL_RECTANGLE);">
<img src="gfx/roundrect-normal.png" width="32" onclick="choose_tool(Paint.TOOL_ROUND_RECT);">
<img src="gfx/bucket-normal.png" width="32" onclick="choose_tool(Paint.TOOL_BUCKET);">
<img src="gfx/oval-normal.png" width="32" onclick="choose_tool(Paint.TOOL_OVAL);">
<img src="gfx/freeshape-normal.png" width="32" onclick="choose_tool(Paint.TOOL_FREE_SHAPE);">
<img src="gfx/text-normal.png" width="32" onclick="choose_tool(Paint.TOOL_TEXT);">
<img src="gfx/regpoly-normal.png" width="32" onclick="choose_tool(Paint.TOOL_REG_POLY);">
<img src="gfx/freepoly-normal.png" width="32" onclick="choose_tool(Paint.TOOL_FREE_POLY);">
<img src="gfx/eyedrop-normal.png" width="32" onclick="choose_tool(Paint.TOOL_EYEDROPPER);">
</div>


<div id="ColorSwatchTable" style="width: 650px; clear: left; font-size: 0;">
</div>


<script>


var gPaint = new Paint(document.getElementById('Container'), [600,400]);


function choose_tool(in_tool)
{
	var img_list = document.getElementById('ToolPalette').children;
	for (var t = 0; t < img_list.length; t++)
	{
		var palette_img = img_list[t];
		palette_img.src = palette_img.src.replace('hilite', 'normal');
	}
	
	/* set the new tool indication */
	var tool_idx = in_tool - 1;
	if (tool_idx > 1) tool_idx -= 2;
	var palette_img = document.getElementById('ToolPalette').children[tool_idx];
	palette_img.src = palette_img.src.replace('normal', 'hilite');
	
	gPaint.choose_tool(in_tool);
}
gPaint.ontoolchange = choose_tool;


function chooseColour(in_event)
{
	var e = in_event || window.event;
	var dom_swatch = e.target;
	var color = dom_swatch.style.backgroundColor.replace('rgb(','').replace(')','').split(',');
	color[0] = color[0] * 1;
	color[1] = color[1] * 1;
	color[2] = color[2] * 1;
	gPaint.choose_color(color);
}


function setupColours()
{
	var dom_table = document.getElementById('ColorSwatchTable');
	
	for (var c = 0; c < Colours.DEFAULT_SET.length; c++)
	{
		var colour = Colours.DEFAULT_SET[c];
		
		var dom_swatch = document.createElement('div');
		dom_swatch.className = 'Swatch';
		dom_swatch.style.backgroundColor = 'rgba('+colour[0]+','+colour[1]+','+colour[2]+',1)';
		dom_table.appendChild(dom_swatch);
		
		dom_swatch.addEventListener('mousedown', chooseColour);
	}
	
	/*var cell_size = dom_table.children[0].clientWidth;
	var per_row = Math.floor(dom_table.clientWidth / dom_table.children[0].clientWidth);
	var rows = Math.ceil(Colours.DEFAULT_SET.length / per_row);
	
	dom_ele.style.width = per_row * cell_size + 'px';
	dom_ele.style.height = rows * cell_size + 'px';*/
	
	
}

setupColours();
choose_tool(Paint.TOOL_BROWSE);
gPaint.choose_color([0,0,0]);

</script>



<h2>Import Paint</h2>
<div><input type="file" id="ImportPaintFile" onchange="gPaint.import_paint(this);"></div>


<h2>Preview</h2>

<div><img src="" id="PasteCheck"></div>

</body>
</html>
